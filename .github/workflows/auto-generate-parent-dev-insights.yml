name: Auto Generate Parent + Development Insights

on:
  schedule:
    # Twice a week to deepen coverage on parent health + development
    - cron: '0 4 * * 1,4'
  workflow_dispatch:

jobs:
  generate-focused-insights:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'
          cache-dependency-path: nextjs-project/package-lock.json

      - name: Create logs directory
        run: mkdir -p logs
        working-directory: ./nextjs-project

      - name: Install dependencies
        working-directory: ./nextjs-project
        run: npm ci

      - name: Optimize AEO Rules
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        working-directory: ./nextjs-project
        run: |
          echo "üß¨ Optimizing content generation rules based on AI traffic..."
          node scripts/optimize-aeo-loop.js

      - name: Generate development + parent health insights
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        working-directory: ./nextjs-project
        run: |
          set -euo pipefail
          echo "üìã Generating development insights (trend-first, allow preset fallback)"
          npm run generate:articles -- --hub development --allow-preset | tee logs/article-generation-development-$(date +%Y-%m-%d-%H%M%S).log
          echo "üìã Generating parent health insights (trend-first, allow preset fallback)"
          npm run generate:articles -- --hub mom-health --allow-preset | tee logs/article-generation-mom-health-$(date +%Y-%m-%d-%H%M%S).log

      - name: Quality gate - duplicate check
        working-directory: ./nextjs-project
        run: npm run check:duplicates

      - name: Quality gate - build
        working-directory: ./nextjs-project
        run: npm run build

      - name: Get statistics
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        working-directory: ./nextjs-project
        run: |
          # È™åËØÅÁéØÂ¢ÉÂèòÈáèÊòØÂê¶Â≠òÂú®
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
            echo "‚ùå NEXT_PUBLIC_SUPABASE_URL is not set in GitHub Secrets"
            echo "   Please add NEXT_PUBLIC_SUPABASE_URL to GitHub Secrets"
            echo "   Expected format: https://your-project-id.supabase.co"
            exit 1
          fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "‚ùå SUPABASE_SERVICE_ROLE_KEY is not set in GitHub Secrets"
            echo "   Please add SUPABASE_SERVICE_ROLE_KEY to GitHub Secrets"
            exit 1
          fi
          # È™åËØÅURLÊ†ºÂºèÔºà‰∏çÊö¥Èú≤ÂÆûÈôÖÂÄºÔºâ
          if [[ ! "$NEXT_PUBLIC_SUPABASE_URL" =~ ^https://[a-z0-9-]+\.supabase\.co$ ]]; then
            echo "‚ùå NEXT_PUBLIC_SUPABASE_URL has invalid format"
            echo "   Expected format: https://your-project-id.supabase.co"
            echo "   Current value starts with: ${NEXT_PUBLIC_SUPABASE_URL:0:20}..."
            echo "   Make sure there's no trailing slash and it's a valid Supabase URL"
            exit 1
          fi
          echo "‚úÖ Environment variables validated"
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL?.trim();
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY?.trim();
          if (!supabaseUrl) {
            console.error('‚ùå NEXT_PUBLIC_SUPABASE_URL is missing');
            process.exit(1);
          }
          if (!supabaseKey) {
            console.error('‚ùå SUPABASE_SERVICE_ROLE_KEY is missing');
            process.exit(1);
          }
          if (!supabaseUrl.startsWith('https://') || !supabaseUrl.endsWith('.supabase.co')) {
            console.error('‚ùå NEXT_PUBLIC_SUPABASE_URL has invalid format');
            console.error('   Expected: https://your-project-id.supabase.co');
            process.exit(1);
          }
          try {
            const supabase = createClient(supabaseUrl, supabaseKey);
            (async () => {
            const { count: totalCount } = await supabase
              .from('articles')
              .select('*', { count: 'exact', head: true })
              .eq('status', 'published');

            const { count: aiCount } = await supabase
              .from('articles')
              .select('*', { count: 'exact', head: true })
              .eq('status', 'published')
              .eq('reviewed_by', 'AI Content Generator');

            const { count: authCount } = await supabase
              .from('articles')
              .select('*', { count: 'exact', head: true })
              .eq('status', 'published')
              .neq('reviewed_by', 'AI Content Generator');

            console.log('üìä Article Statistics:');
            console.log(\`   Total published: \${totalCount}\`);
            console.log(\`   AI-generated insights: \${aiCount}\`);
            console.log(\`   Authoritative articles: \${authCount}\`);
          })();
          } catch (error) {
            console.error('‚ùå Error creating Supabase client:', error.message);
            process.exit(1);
          }
          "

      - name: Trigger page revalidation
        if: success()
        env:
          REVALIDATION_SECRET: ${{ secrets.REVALIDATION_SECRET }}
          SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://www.momaiagent.com' }}
        run: |
          echo "üîÑ Triggering page revalidation..."
          echo "üìç SITE_URL: ${SITE_URL}"
          if [ -z "$REVALIDATION_SECRET" ]; then
            echo "‚ùå REVALIDATION_SECRET not set, cannot revalidate"
            echo "   Please set REVALIDATION_SECRET in GitHub Secrets"
            exit 1
          fi
          echo "‚úÖ REVALIDATION_SECRET is set (length: ${#REVALIDATION_SECRET})"
          
          echo "üì° Calling revalidation API: ${SITE_URL}/api/revalidate"
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "‚è±Ô∏è  Attempt ${attempt}/${max_attempts}"
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "${SITE_URL}/api/revalidate" \
              -H "Authorization: Bearer ${REVALIDATION_SECRET}" \
              -H "Content-Type: application/json" \
            -d '{"path": "/insight", "tag": "insights"}')
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            echo "üì• Response HTTP code: ${http_code}"
            echo "üì• Response body: ${body}"
            
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Revalidation successful"
              echo "$body" | jq '.' 2>/dev/null || echo "$body"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "‚ö†Ô∏è  Revalidation failed (HTTP $http_code), retrying in 5s..."
              sleep 5
            fi
            attempt=$((attempt + 1))
          done
          
          echo "‚ùå Revalidation failed after ${max_attempts} attempts"
          echo "   Check REVALIDATION_SECRET and SITE_URL configuration"
          exit 1

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parent-dev-article-generation-logs
          path: nextjs-project/logs/article-generation-*.log
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Parent + Development insight generation failed"
