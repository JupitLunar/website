name: Weekly Link Check

on:
  # Run every Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  link-check:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: nextjs-project/package-lock.json

      - name: Install dependencies
        working-directory: ./nextjs-project
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./nextjs-project
        run: npx playwright install chromium

      - name: Build Next.js app
        working-directory: ./nextjs-project
        run: npm run build
        env:
          NEXT_PUBLIC_SITE_URL: https://www.momaiagent.com
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Start Next.js server
        working-directory: ./nextjs-project
        run: |
          npm run start &
          sleep 10
        env:
          NEXT_PUBLIC_SITE_URL: https://www.momaiagent.com
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Run link check audit
        working-directory: ./nextjs-project
        run: node ../.agent/skills/website-audit/scripts/audit-scout.js
        continue-on-error: true

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-report
          path: nextjs-project/audit-report.json
          retention-days: 30

      - name: Check for broken links
        id: check-links
        working-directory: ./nextjs-project
        run: |
          BROKEN_COUNT=$(node -e "const report = require('./audit-report.json'); console.log(report.stats.broken);")
          echo "broken_count=$BROKEN_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$BROKEN_COUNT" -gt 0 ]; then
            echo "âŒ Found $BROKEN_COUNT broken links"
            exit 1
          else
            echo "âœ… No broken links found"
          fi

      - name: Create issue if links are broken
        if: failure() && steps.check-links.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('./nextjs-project/audit-report.json', 'utf8'));
            
            const brokenLinks = report.brokenLinks
              .map(link => `- [${link.status || link.error}] ${link.url}`)
              .join('\n');
            
            const issueBody = `## ðŸ”— Broken Links Detected
            
            **Date**: ${new Date().toISOString()}
            **Total Broken Links**: ${report.stats.broken}
            **Pages Scanned**: ${report.stats.scanned}
            
            ### Broken Links
            ${brokenLinks}
            
            ### Actions Needed
            1. Review the broken links above
            2. Update or remove broken URLs
            3. Run the audit locally to verify fixes
            4. Re-run this workflow to confirm
            
            [View full audit report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            // Check if an issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-links'
            });
            
            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ”— Broken Links Detected - ${report.stats.broken} links`,
                body: issueBody,
                labels: ['broken-links', 'automated']
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: issueBody
              });
            }

      - name: Send Slack notification (optional)
        if: failure() && steps.check-links.outcome == 'failure'
        run: |
          # Uncomment and configure if you want Slack notifications
          # curl -X POST -H 'Content-type: application/json' \
          # --data '{"text":"ðŸ”— Broken links detected on momaiagent.com! Check GitHub Actions for details."}' \
          # ${{ secrets.SLACK_WEBHOOK_URL }}
          echo "Slack notification skipped (not configured)"
