name: Auto Generate Trending Insights

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      hub:
        description: 'Content hub (optional - leave empty for random selection from trending topics or preset topics)'
        required: false
        type: choice
        options:
          - ''
          - feeding
          - sleep
          - mom-health
          - development
          - safety
          - recipes

jobs:
  generate-articles:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'
          cache-dependency-path: nextjs-project/package-lock.json

      - name: Create logs directory
        run: mkdir -p logs
        working-directory: ./nextjs-project

      - name: Install dependencies
        working-directory: ./nextjs-project
        run: npm ci

      - name: Optimize AEO Rules
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        working-directory: ./nextjs-project
        run: |
          echo "ğŸ§¬ Optimizing content generation rules based on AI traffic..."
          node scripts/optimize-aeo-loop.js

      - name: Generate articles
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          HUB: ${{ github.event.inputs.hub }}
        working-directory: ./nextjs-project
        run: |
          if [ -n "$HUB" ]; then
            echo "ğŸ“‹ Generating articles for hub: $HUB"
            npm run generate:articles -- --hub "$HUB" | tee logs/article-generation-$(date +%Y-%m-%d-%H%M%S).log
          else
            echo "ğŸ² No hub specified, using trend-first insights"
            npm run generate:articles | tee logs/article-generation-$(date +%Y-%m-%d-%H%M%S).log
          fi

      - name: Quality gate - duplicate check
        working-directory: ./nextjs-project
        run: npm run check:duplicates

      - name: Quality gate - build
        working-directory: ./nextjs-project
        run: npm run build

      - name: Get statistics
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        working-directory: ./nextjs-project
        run: |
          # éªŒè¯ç¯å¢ƒå˜é‡æ˜¯å¦å­˜åœ¨
          if [ -z "$NEXT_PUBLIC_SUPABASE_URL" ]; then
            echo "âŒ NEXT_PUBLIC_SUPABASE_URL is not set in GitHub Secrets"
            echo "   Please add NEXT_PUBLIC_SUPABASE_URL to GitHub Secrets"
            echo "   Expected format: https://your-project-id.supabase.co"
            exit 1
          fi
          if [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
            echo "âŒ SUPABASE_SERVICE_ROLE_KEY is not set in GitHub Secrets"
            echo "   Please add SUPABASE_SERVICE_ROLE_KEY to GitHub Secrets"
            exit 1
          fi
          # éªŒè¯URLæ ¼å¼ï¼ˆä¸æš´éœ²å®é™…å€¼ï¼‰
          if [[ ! "$NEXT_PUBLIC_SUPABASE_URL" =~ ^https://[a-z0-9-]+\.supabase\.co$ ]]; then
            echo "âŒ NEXT_PUBLIC_SUPABASE_URL has invalid format"
            echo "   Expected format: https://your-project-id.supabase.co"
            echo "   Current value starts with: ${NEXT_PUBLIC_SUPABASE_URL:0:20}..."
            echo "   Make sure there's no trailing slash and it's a valid Supabase URL"
            exit 1
          fi
          echo "âœ… Environment variables validated"
          node -e "
          const { createClient } = require('@supabase/supabase-js');
          const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL?.trim();
          const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY?.trim();
          if (!supabaseUrl) {
            console.error('âŒ NEXT_PUBLIC_SUPABASE_URL is missing');
            process.exit(1);
          }
          if (!supabaseKey) {
            console.error('âŒ SUPABASE_SERVICE_ROLE_KEY is missing');
            process.exit(1);
          }
          if (!supabaseUrl.startsWith('https://') || !supabaseUrl.endsWith('.supabase.co')) {
            console.error('âŒ NEXT_PUBLIC_SUPABASE_URL has invalid format');
            console.error('   Expected: https://your-project-id.supabase.co');
            process.exit(1);
          }
          try {
            const supabase = createClient(supabaseUrl, supabaseKey);
            (async () => {
            // Total articles
            const { count: totalCount } = await supabase
              .from('articles')
              .select('*', { count: 'exact', head: true })
              .eq('status', 'published');

            // AI-generated insights (using reviewed_by field, not article_source)
            const { count: aiCount } = await supabase
              .from('articles')
              .select('*', { count: 'exact', head: true })
              .eq('status', 'published')
              .eq('reviewed_by', 'AI Content Generator');

            // Authoritative articles (not AI-generated)
            const { count: authCount } = await supabase
              .from('articles')
              .select('*', { count: 'exact', head: true })
              .eq('status', 'published')
              .neq('reviewed_by', 'AI Content Generator');

            console.log('ğŸ“Š Article Statistics:');
            console.log(\`   Total published: \${totalCount}\`);
            console.log(\`   AI-generated insights: \${aiCount}\`);
            console.log(\`   Authoritative articles: \${authCount}\`);

            // Latest AI-generated insights (using reviewed_by field)
            const { data: latestInsights } = await supabase
              .from('articles')
              .select('title, hub, created_at')
              .eq('status', 'published')
              .eq('reviewed_by', 'AI Content Generator')
              .order('created_at', { ascending: false })
              .limit(5);

            console.log('\nğŸ’¡ Latest 5 AI-generated insights:');
            if (latestInsights && latestInsights.length > 0) {
              latestInsights.forEach((a, i) => {
                console.log(\`  \${i+1}. [\${a.hub}] \${a.title.substring(0, 60)}\`);
              });
            } else {
              console.log('   No insights yet');
            }
          })();
          } catch (error) {
            console.error('âŒ Error creating Supabase client:', error.message);
            process.exit(1);
          }
          "

      - name: Trigger page revalidation
        if: success()
        env:
          REVALIDATION_SECRET: ${{ secrets.REVALIDATION_SECRET }}
          SITE_URL: ${{ secrets.NEXT_PUBLIC_SITE_URL || 'https://www.momaiagent.com' }}
        run: |
          echo "ğŸ”„ Triggering page revalidation..."
          echo "ğŸ“ SITE_URL: ${SITE_URL}"
          if [ -z "$REVALIDATION_SECRET" ]; then
            echo "âŒ REVALIDATION_SECRET not set, cannot revalidate"
            echo "   Please set REVALIDATION_SECRET in GitHub Secrets"
            exit 1
          fi
          echo "âœ… REVALIDATION_SECRET is set (length: ${#REVALIDATION_SECRET})"
          
          echo "ğŸ“¡ Calling revalidation API: ${SITE_URL}/api/revalidate"
          max_attempts=3
          attempt=1
          while [ $attempt -le $max_attempts ]; do
            echo "â±ï¸  Attempt ${attempt}/${max_attempts}"
            response=$(curl -s -w "\n%{http_code}" -X POST \
              "${SITE_URL}/api/revalidate" \
              -H "Authorization: Bearer ${REVALIDATION_SECRET}" \
              -H "Content-Type: application/json" \
            -d '{"path": "/insight", "tag": "insights"}')
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            echo "ğŸ“¥ Response HTTP code: ${http_code}"
            echo "ğŸ“¥ Response body: ${body}"
            
            if [ "$http_code" = "200" ]; then
              echo "âœ… Revalidation successful"
              echo "$body" | jq '.' 2>/dev/null || echo "$body"
              exit 0
            fi
            
            if [ $attempt -lt $max_attempts ]; then
              echo "âš ï¸  Revalidation failed (HTTP $http_code), retrying in 5s..."
              sleep 5
            fi
            attempt=$((attempt + 1))
          done
          
          echo "âŒ Revalidation failed after ${max_attempts} attempts"
          echo "   Check REVALIDATION_SECRET and SITE_URL configuration"
          exit 1

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: article-generation-logs
          path: nextjs-project/logs/article-generation-*.log
          retention-days: 30

      - name: Notify on failure
        if: failure()
        run: |
          echo "::warning::Article generation failed"
          # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ Slack/Emailé€šçŸ¥
